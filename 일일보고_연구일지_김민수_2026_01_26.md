# 일일보고_연구일지_김민수_2026_01_26

## 주요 항목 요약

### 오늘 달성
- **카테고리 리포트 불릿 생성 파이프라인 구축**: `products_all.csv` 기반으로 카테고리 요약 불릿(`summaryBullets`)을 **JSON 형태로 생성**하는 흐름 구현
- **LoRA 학습/추론 스크립트 작성 및 실행**: Qwen2.5 Instruct + LoRA(PEFT) 기반 SFT 학습/추론 스크립트 구성 및 학습 완료
- **Windows 환경 이슈 대응으로 안정성 확보**
  - `pip requirements.txt` 인코딩(cp949) 이슈 회피용 `requirements_pip.txt` 추가
  - 학습 중 `requires_grad`/gradient checkpointing 이슈 해결로 학습 정상화
  - 추론 시 JSON 파싱 실패(Extra data/깨진 JSON) 대응 및 **폴백(템플릿 기반)** 추가
  - 추론 시 Windows 페이징 파일 부족(os error 1455) 대응으로 **`--template_only` 옵션** 추가 → 모델 없이도 안정적으로 불릿 생성 가능
- **불릿 품질 개선(다나와 데이터만으로 가능한 지표 확장)**
  - 상품수/브랜드수/누적리뷰/리뷰0비율/저평점비율/가격 분위수(P25,P50,P75)/6개월 가격변화(중앙값)/상위브랜드 집중도/리뷰 채널 분포/키워드 요약 포함

### 이슈
- **pip 설치 실패(인코딩 문제)**: `requirements.txt` 내 한글 주석으로 pip가 cp949 디코딩 실패 → `requirements_pip.txt`로 해결
- **학습 중 backward 실패**: gradient checkpointing + PEFT 조합에서 grad 미전파(`does not require grad`) → 입력 grad 활성화로 해결
- **추론 JSON 파싱 실패**: 모델 출력에 프롬프트/여러 JSON이 섞이거나 JSON 문법이 깨짐 → 생성 토큰만 디코딩 + robust 파싱 + 검증/폴백 적용
- **추론 시 모델 로드 실패(os error 1455)**: Windows 페이징 파일 부족으로 모델 샤드 로딩 실패 → `--template_only`로 우회 및 모델 로드 실패 시 폴백

---

## 작업 내용 요약

### 1) 카테고리 리포트 불릿 생성 기능 구현(다나와 데이터 기반)

`products_all.csv`의 카테고리별 집계 데이터를 활용해, UI의 “원형 그래프 아래 요약 텍스트”를 **`summaryBullets: string[]` JSON**으로 생성하는 로직 구현

**추가/개선된 지표(다나와 데이터만으로 계산):**
- **시장 규모**: 상품 수, 브랜드 수, 누적 리뷰 수
- **포화/검증**: 리뷰 0건 상품 비중
- **만족/리스크**: 가중 평균 평점, 1~2점 비중
- **가격대/추이**: 가격 분위수(P25/P50/P75), 6개월 가격변화(제품별 중앙값)
- **경쟁구도**: 상위 3개 브랜드 점유율(리뷰 기준) 및 집중도
- **채널**: 리뷰 플랫폼 분포 상위 채널(“리뷰 분포 기준”으로 명시)
- **키워드**: 리뷰 태그 상위 키워드

---

### 2) 학습/추론 코드(LoRA 기반) 구성

**구성 요소:**
- **학습 데이터 생성(JSONL)**: 카테고리별 metrics → 타깃 불릿(JSON) 페어로 SFT 데이터 생성
- **LoRA 학습**: Qwen2.5-3B-Instruct + PEFT LoRA로 SFT 수행
- **추론**: JSON-only 출력 유도, 출력 검증/폴백 적용

---

### 3) Windows 환경 대응(운영/개발 안정성)

- **pip 인코딩 문제 회피**: `requirements_pip.txt` 추가로 설치 가능 상태 확보
- **메모리/페이징 이슈 대응**: 모델 로드 실패 시에도 서비스가 멈추지 않도록 템플릿 기반 생성 모드(`--template_only`) 제공
- **PowerShell 실행 편의**: 스크립트 실행 방식(`python ...`) 중심으로 정리

---

## 생성된 파일 목록

| 파일명 | 역할 |
|--------|------|
| `ai_report_bullets_lib.py` | 카테고리 집계/불릿 생성 공용 로직(다나와 기반 지표 확장 포함) |
| `19_prepare_category_bullet_sft.py` | `products_all.csv` → 카테고리 불릿 SFT 학습용 JSONL 생성 |
| `20_train_category_bullet_lora.py` | Qwen2.5 Instruct + LoRA 학습 스크립트 |
| `21_generate_category_bullets.py` | 카테고리 불릿 JSON 생성(추론) + `--template_only` 지원 |
| `requirements_lora.txt` | LoRA 학습용 추가 패키지 목록(`peft`) |
| `requirements_pip.txt` | Windows pip 인코딩 이슈 회피용 ASCII requirements |

---

## 실행/검증 결과 요약

- **템플릿 기반 생성(`--template_only`) 정상 출력 확인**
  - `summaryBullets`가 유효한 JSON으로 출력됨
  - 포함 내용: 상품/브랜드/리뷰 규모, 리뷰0 비율, 평점 및 저평점 비중, 가격 분위수/추이, 상위 채널 분포, 상위 브랜드/집중도, 키워드, 업데이트 기간

---

## 정리

### 성과
- 카테고리 리포트의 핵심 “요약 불릿”을 **API에 바로 붙일 수 있는 JSON 형태로 안정적으로 생성** 가능
- 학습/추론 파이프라인 구성 완료(LoRA) 및 Windows 환경 이슈 대응 완료
- 다나와 데이터만으로도 “진출 판단용 인사이트”에 가까운 지표(가격/경쟁/리스크/포화)를 불릿에 반영

### 발견된 문제
- Windows 환경에서 대형 모델 로딩이 페이징 파일 제약을 받음(os error 1455) → 운영환경 스펙/설정 필요
- 학습 데이터가 적을 경우 모델이 JSON-only/문장 스타일을 불안정하게 출력 → 데이터 확대 및 품질 고도화 필요

---

## 다음 단계 계획

### 1) 품질 고도화(불릿)
- 불릿을 UI용 **고정 템플릿(6~8줄, 순서 고정)** 형태로 정규화
- “리뷰 분포 기준”과 같이 근거를 명확히 표기(환각 방지), 문장 톤/표현 일관성 강화
- `unit_price`, `specifications`에서 세그먼트(연령/구성/용량 등) 추출하여 “유망 세그먼트” 1줄 추가

### 2) 학습 데이터 확장 및 LoRA 재학습
- `19_prepare_category_bullet_sft.py`로 카테고리 샘플 수 확대(다양한 카테고리 포함)
- 재학습 후 모델 출력 품질(문장 자연스러움/JSON 안정성) 개선 확인

### 3) 백엔드 연동(MVP)
- Node.js API에서 `--template_only` 기반으로 먼저 안정적으로 연결(서비스 중단 없이 제공)
- 운영 환경에서 메모리/페이징 설정 확보 시 모델 모드 옵션화(점진적 전환)

---

## 기술 스택

- **데이터**: `products_all.csv` (상품 + 리뷰 요약 컬럼)
- **모델(학습)**: `Qwen/Qwen2.5-3B-Instruct` + LoRA(PEFT)
- **프레임워크**: Transformers, Datasets, Accelerate, PyTorch
- **언어/환경**: Python 3.11, Windows(PowerShell)

