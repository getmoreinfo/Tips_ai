# 일일보고_연구일지_김민수_2026_01_20

## 주요 항목 요약

### 오늘 달성
- PostgreSQL(public1.products) 전체 데이터 CSV 내보내기 성공 (11,356개 상품)
- `intfloat/multilingual-e5-base` 모델 기반 카테고리 분류 파인튜닝 완료
- 상품명(name) → 카테고리(category) 분류 모델 학습 및 검증 (정확도 **89.34%**)
- GPU 메모리 최적화 설정으로 8GB GPU(RTX 4060 Ti)에서 안정적 학습 성공

### 이슈
- `intfloat/multilingual-e5-large` 모델 사용 시 8GB GPU 메모리 부족으로 OOM 에러 발생
- `max_length=192` 설정 시 체크포인트 저장 단계에서 MemoryError 발생
- Early Stopping 적용했으나 7 epoch 전체 실행됨 (정확도 지속 상승)

---

## 작업 내용 요약

### 1) 전체 상품 데이터 CSV 내보내기 (`export_all_products.py`)

PostgreSQL에서 전체 products 테이블 추출 성공

```python
# PostgreSQL 연결 및 전체 데이터 추출
db_config = {
    'host': os.getenv('PGHOST'),
    'port': os.getenv('PGPORT'),
    'database': 'danawa_crawlingdb',
    'user': os.getenv('PGUSER'),
    'password': os.getenv('PGPASSWORD')
}
conn = psycopg2.connect(**db_config)
df = pd.read_sql("SELECT * FROM public1.products", conn)
df.to_csv('products_all.csv', index=False, encoding='utf-8-sig')
```

**결과:**
- 전체 레코드: 11,356개
- 컬럼 수: 20개
- 파일 크기: 12.65 MB

---

### 2) 카테고리 분류 모델 학습 (`05_train_category_classifier.py`)

상품명 + 제조사로 카테고리를 예측하는 분류 모델 학습

```python
# 모델 설정
model_name = "intfloat/multilingual-e5-base"  # large → base (메모리 최적화)
num_labels = 36  # 카테고리 수

# 학습 데이터 구성
df['text'] = df['name'] + ' | ' + df['manufacturer']

# 학습 설정 (8GB GPU 최적화)
training_args = TrainingArguments(
    per_device_train_batch_size=4,
    gradient_accumulation_steps=8,  # 효과적 배치: 32
    fp16=True,
    learning_rate=3e-5,
    num_train_epochs=7,
    save_safetensors=False,  # 메모리 절약
)

# Early Stopping 적용
trainer = Trainer(
    model=model,
    callbacks=[EarlyStoppingCallback(early_stopping_patience=2)]
)
trainer.train()
```

**학습 결과:**

| Epoch | Validation Accuracy | Validation F1 |
|-------|---------------------|---------------|
| 1 | 75.95% | 0.7145 |
| 2 | 85.37% | 0.8398 |
| 3 | 87.14% | 0.8652 |
| 4 | 87.67% | 0.8724 |
| 5 | 89.25% | 0.8932 |
| 6 | 89.34% | 0.8927 |
| 7 | 89.34% | 0.8925 |

---

### 3) 모델 테스트 (`06_use_category_classifier.py`)

학습된 모델로 새로운 상품 분류 테스트

```python
class CategoryClassifier:
    def predict(self, product_name, manufacturer='', top_k=3):
        text = f"{product_name} | {manufacturer}"
        inputs = self.tokenizer(text, return_tensors='pt', ...)
        outputs = self.model(**inputs)
        # Top-k 예측 결과 반환
```

**테스트 결과 (예시):**

| 상품명 | 예측 카테고리 | 신뢰도 |
|--------|--------------|--------|
| 에르고베이비 옴니 브리즈 아기띠 | 아기띠/외출용품 | 94.8% |
| 뽀로로 장난감 자동차 | 로봇/배틀카드 | 23.6% |
| 하기스 기저귀 점보팩 | 아기띠/외출용품 | 59.1% (오분류) |

---

### 4) 메모리 최적화 과정

| 시도 | 설정 | 결과 |
|------|------|------|
| 1차 | e5-large, batch=8 | OOM 에러 |
| 2차 | e5-base, batch=2 | OOM 에러 |
| 3차 | e5-base, batch=4, max_length=192 | MemoryError (저장 시) |
| 4차 | e5-base, batch=4, max_length=128, save_safetensors=False | **성공** |

---

## 생성된 파일 목록

| 파일명 | 역할 |
|--------|------|
| `export_all_products.py` | DB → CSV 전체 내보내기 |
| `products_all.csv` | 전체 상품 데이터 (11,356개) |
| `05_train_category_classifier.py` | 카테고리 분류 모델 학습 |
| `05_save_trained_model.py` | 체크포인트 → 최종 모델 저장 |
| `06_use_category_classifier.py` | 학습된 모델 사용/테스트 |
| `results_category/finetuned_category_classifier/` | 저장된 모델 |

---

## 정리

- 전체 상품 데이터(11,356개) 기반 카테고리 분류 모델 학습 완료
- 상품명 + 제조사만으로 **89.34% 정확도** 달성
- 8GB GPU 환경에서 안정적으로 동작하는 설정 확립

---

## 다음 단계 계획

1. **정확도 향상 방안 검토**
   - 더 많은 학습 데이터 확보
   - specifications(상품 스펙) 정보 추가 활용
   - 카테고리 계층 구조 활용 (상위 카테고리 먼저 분류)

2. **실서비스 적용 준비**
   - 모델 추론 API 구성
   - 배치 예측 성능 테스트
   - 신규 상품 자동 분류 파이프라인 구축

3. **오분류 분석**
   - 비슷한 카테고리 간 혼동 패턴 분석
   - 특정 카테고리 정확도 개선
