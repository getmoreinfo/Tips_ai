## 일일보고_연구일지_김민수_2026_01_28

### 주요 항목 요약

- **리포트 자동작성 전용 AI 설계·구현**  
  - 카테고리 리포트의 “시장 구조 요약(Insight Summary)”와 “성장 요약”을 자동 생성하는 파이프라인 완성  
  - 리뷰 수를 **매출/판매의 대리 지표(proxy)** 로 사용하는 것을 전제로, 매출·점유율·성장률을 “리뷰 기준 추정”으로만 해석하도록 설계
- **사용 모델 및 학습 기준 정리**  
  - 베이스 모델: `Qwen/Qwen2.5-1.5B-Instruct` (8GB GPU 환경 대응)  
  - 파인튜닝: LoRA(PEFT) + 템플릿 기반 SFT  
  - 학습 데이터는 CSV(`products_all.csv`, `reviews_all.csv`)에서 집계한 정량 지표 + 템플릿이 생성한 정성 요약을 짝지어 구성
- **카테고리 리포트 JSON 표준 구조 확립**  
  - `charts`(Top10 브랜드 도넛 + 가상 매출 성장 그래프) + `summaries`(Insight Summary + 성장 요약) + `assumptions`(proxy/가정)을 포함하는 단일 JSON 포맷 정의  
  - 로컬 뷰어(`report_viewer.html`)에서 실제 리포트 UI 형태로 시각화 가능
- **Insight Summary 템플릿 고도화**  
  - 전제 → 시장 한 줄 결론 → 경쟁 구조 → 성숙도/품질 → 소비자 의사결정 → 실행 시사점의 6단 구조 정립  
  - 각 판단 문단마다 **핵심 수치 1개(상위3 브랜드 비중, 리뷰 0건 비중, HHI, 평균 평점, 전체 리뷰 수 등)** 를 포함하도록 규칙화

---

### 1) 사용 모델·학습 기준

#### 1-1. 모델 선택 및 파인튜닝 방식

- **베이스 모델**: `Qwen/Qwen2.5-1.5B-Instruct`  
  - 기존 카테고리 불릿에서는 3B 모델을 사용했으나, Windows + 8GB GPU 환경에서 OOM 및 페이징 파일 오류가 잦았음  
  - 리포트 요약은 “새로운 사실 생성”보다 **이미 계산된 지표를 해석하는 작업**이므로 1.5B 사이즈로도 충분하다고 판단
- **파인튜닝 방식**: LoRA(저랭크 어댑터)  
  - 스크립트: `23_train_report_summary_lora.py`  
  - 주요 하이퍼파라미터:
    - `lora_r = 4`, `lora_alpha = 8` (메모리 절약 위주)  
    - `max_length = 1024`  
    - `epochs = 3`, `batch_size = 1`, `grad_accum = 16`  
  - 1차 학습 결과:
    - 학습 데이터: 40 examples (4개 카테고리 × 10샘플)  
    - 학습 시간: 약 92초  
    - `train_loss ≈ 0.0` (데이터가 적어 과적합에 가까운 상태, 이후 200샘플 재생성 완료)

#### 1-2. 학습 데이터 생성 기준 (SFT)

- **데이터 소스**  
  - 상품: `products_all.csv`  
  - 리뷰: `reviews_all.csv`
- **생성 스크립트**: `22_prepare_report_summary_sft.py`
  - 카테고리별로 다음 단계를 수행:
    1. `aggregate_category_with_reviews()`  
       - 카테고리 단위 `CategoryMetrics` 계산  
       - 총 리뷰 수, 브랜드 수, 상위 브랜드 리뷰 비중, 리뷰 0건 비중, 가중 평균 평점, 저평점 비중  
       - 상위 브랜드 리스트, 상위 태그/세그먼트, 가격 분위수(P25/50/75) 등
    2. `calculate_yearly_growth()`  
       - 날짜 컬럼(`review_date` → `first_seen_at` → `last_seen_at` → `created_at` → `updated_at`) 우선순위로 연도 추출  
       - 연도별 리뷰 수 집계 후  
         `estimated_units = review_count * units_per_review` (기본 3.0)  
         `estimated_revenue = estimated_units * price_ref` (카테고리 가격 중앙값 등)  
       - 전년 대비 성장률은 `estimated_revenue` 기준으로 계산
    3. `build_market_overview_summary()` / `build_growth_summary()`  
       - 위 지표를 인풋으로 받아 **시장 구조 요약(Insight Summary)**, **성장 요약**을 템플릿 기반으로 생성
    4. 입력(JSON)과 출력(JSON)을 묶어  
       `{"messages":[system, user(json), assistant(json)]}` 형식의 SFT JSONL 레코드로 저장
- **샘플 수**
  - 1차: 4개 카테고리 × 10샘플 = 40 examples (`training_report_summary_sft.jsonl`)  
  - 2차: 4개 카테고리 × 50샘플 = 200 examples (`training_report_summary_sft_200.jsonl`)
- **핵심 전제(프롬프트)**  
  - Danawa에는 실제 매출/판매량 데이터가 없으며,  
    리포트에서 사용하는 “매출, 점유율, 성장률”은 모두 **“리뷰 수를 매출/판매의 대리 지표(proxy)로 사용한 상대적 추정”** 임을 시스템 프롬프트와 첫 문장에서 반복적으로 명시  
  - “판단됩니다/추정됩니다”보다는 “~한 구조입니다/환경입니다”와 같은 컨설팅 리포트 톤을 유지

---

### 2) Insight Summary 템플릿 설계

#### 2-1. 구현 위치 및 데이터 구조

- 파일: `report_summary_lib.py`
  - `GrowthMetrics`  
    - `year`, `review_count`, `estimated_units`, `estimated_revenue`, `growth_rate`, `price_ref`  
  - `calculate_yearly_growth(df_reviews, price_ref, units_per_review, start_year, end_year)`  
    - 날짜 컬럼을 자동 탐지 후 연도별 리뷰 수 집계  
    - 리뷰 수 → 가상 판매량·매출로 변환 → 연도별 성장률 계산
  - `build_market_overview_summary(metrics, growth_metrics)`  
    - 오늘 집중 수정한 **Insight Summary 본문 템플릿**
  - `build_growth_summary(growth_metrics)`  
    - 연도별 가상 매출/성장률을 기반으로 성장 패턴 해석

#### 2-2. Insight Summary 최종 구조 (6문단)

1. **전제 문장**  
   - 예:  
     - “본 분석은 아기띠/외출용품 카테고리에서 수집된 리뷰 수를 실제 매출 대신 판매 규모와 점유를 가늠하기 위한 대리 지표로 활용해 구조를 추정한 결과입니다.”
2. **시장 한 줄 결론**  
   - 상위 3개 브랜드 비중(예: 45.5%), 리뷰 0건 비중(예: 44.4%)을 각각 한 번씩만 사용  
   - 진입 난이도(리더 그룹 vs 분산 구조) + 성장/성숙도(검증 수준)까지 한 문단에 요약
3. **경쟁 구조 요약**  
   - 상위 브랜드 리스트는 그래프에서 보이므로, 텍스트에는 **HHI 한 숫자**만 사용  
   - 예:  
     - “상위 10개 브랜드 기준 HHI 지수는 약 831 수준으로, 여러 브랜드가 비슷한 비중으로 경쟁하는 구조에 가까워 단일 브랜드의 영향력이 절대적으로 크지는 않습니다.”
4. **시장 성숙도 및 품질 수준**  
   - 가중 평균 평점(예: 4.7점) + 저평점 비중을 한 문단에서 해석  
5. **소비자 의사결정 방식**  
   - 전체 리뷰 수(예: 17,446건) + 상위 세그먼트/키워드 2~3개를 조합  
   - “브랜드 인지도보다는 사용 상황·체감 효용이 더 중요한 시장”인지 명확하게 서술
6. **실행 시사점**  
   - 신규 진입 시 **행동 가능한 시사점**으로 마무리  
   - 예:  
     - 초기 리뷰를 몇 개 상품에 집중 → “검증된 선택지” 이미지를 빠르게 형성  
     - 타깃 연령·사용 상황·휴대성 등 **구체적인 사용 시나리오를 상품명/상세에 일관되게 반영**  
     - 리뷰 콘텐츠를 별점 중심이 아니라 **구체적인 사용 경험 + 사진** 중심으로 설계

#### 2-3. “핵심 수치 1개” 규칙 반영

- 각 판단 문단마다 숫자는 최대 1개(많아도 2개)만 쓰도록 템플릿을 설계  
  - 상위 3개 브랜드 비중: `top3_brand_share` → `%` 한 번  
  - 리뷰 0건 비중: `zero_review_ratio` → `%` 한 번  
  - HHI: 상위 10개 브랜드 share에서 계산한 `hhi` → 정수 한 번  
  - 평균 평점: `avg_rating_weighted` → 소수 한 번  
  - 전체 리뷰 수: `total_review_count` → 한 번  
- 나머지 숫자는 그래프(도넛, 성장 차트)에 맡기고, 텍스트는 **의미·판단·시사점 중심**으로 구성

---

### 3) End-to-End 리포트 생성/렌더링 파이프라인

#### 3-1. 카테고리 리포트 JSON 생성

- 스크립트: `25_generate_category_report_from_csv.py`
- 입력: `products_all.csv`, `reviews_all.csv`
- 처리 단계:
  1. `--category_id` 또는 `--category_contains`로 대상 카테고리 선택  
  2. 해당 카테고리 상품 id 리스트 기준으로 `reviews_all.csv` 에서 연관 리뷰만 필터  
  3. `aggregate_category_with_reviews()`로 카테고리 메트릭 계산  
  4. `calculate_yearly_growth()`로 연도별 리뷰·가상 판매·가상 매출·성장률 계산  
  5. `build_market_overview_summary()`, `build_growth_summary()` 호출  
  6. 최종 JSON 생성:
     - `categoryId`, `categoryName`  
     - `charts.brandTop10Donut.items` (도넛 그래프용)  
     - `charts.growthLine.points` (연도별 가상 매출/성장률)  
     - `summaries.marketOverviewSummary`, `summaries.growthSummary`  
     - `assumptions` (proxy 타입, `unitsPerReview`, `priceRef`)

- 예시 실행:

```powershell
cd C:\Users\comso-1407\dev\tips_ai

python 25_generate_category_report_from_csv.py `
  --category_contains 유모차 `
  --out_json report_stroller.json
```

```powershell
python 25_generate_category_report_from_csv.py `
  --category_contains "그림/동화/놀이책" `
  --out_json report_storybook.json
```

#### 3-2. 리포트 뷰어를 통한 시각 검증

- HTML 뷰어: `report_viewer.html`
  - 좌측: Top10 브랜드 도넛 + Insight Summary  
  - 우측: (가능한 경우) 가상 매출 성장 라인 그래프 + 성장 요약
- 로컬 서버: `serve_report_viewer.py`

```powershell
cd C:\Users\comso-1407\dev\tips_ai
python serve_report_viewer.py --port 8000
```

- 브라우저 접속:
  - 유모차(아기띠/외출용품):  
    `http://127.0.0.1:8000/report_viewer.html?json=report_stroller.json`
  - 그림/동화/놀이책:  
    `http://127.0.0.1:8000/report_viewer.html?json=report_storybook.json`

---

### 4) 결과 및 평가

#### 성과

- **컨설팅용 카테고리 리포트 자동작성 기반 확보**  
  - 리뷰 기반 proxy 지표를 사용하여, 실제 매출이 없어도 **시장 구조·경쟁 구도·성숙도·의사결정 패턴·실행 시사점**을 한 번에 설명하는 Insight Summary 자동 생성
- **모델 학습 파이프라인 정리**  
  - Qwen2.5-1.5B + LoRA 조합으로 8GB GPU에서도 안정적으로 학습·추론 가능한 세팅을 정립  
  - CSV 기반 SFT 데이터 생성 → LoRA 학습 → 추론 스크립트 → 리포트 JSON → HTML 뷰어까지 풀 체인 확보
- **클라이언트 의사결정 친화적 구조**  
  - 숫자 자체보다 “진입 난이도, 경쟁 구조, 검증 수준, 소비자 선택 기준, 실행 시사점”을 순서대로 읽을 수 있는 형식으로 통일  
  - 각 판단 문단에 1개의 핵심 수치를 붙여, 숫자-해석-시사점 연결이 직관적으로 보이도록 구현

#### 한계/이슈

- **학습 데이터 규모 제한**  
  - 현재 `products_all.csv`에 포함된 카테고리가 4개 수준이라 SFT 데이터가 아직 적음  
  - 40 example 학습 결과 `train_loss=0.0`으로 과적합 가능성이 높고, 200 example 버전으로 재학습이 필요
- **성장 그래프 데이터 부족**  
  - 일부 카테고리는 리뷰 날짜(`review_date` 등)가 충분치 않아 연도별 성장률을 안정적으로 계산하기 어렵고,  
    이 경우 성장 요약은 “성장 데이터 부족” 메시지로 대체
- **모델 출력 형식 안정성**  
  - LoRA 모델은 여전히 JSON 스키마를 가끔 벗어나므로, 실전에서는 템플릿을 기본으로 사용하고  
    모델 출력은 참고/연구용으로 활용하는 방향이 현실적

---

### 5) 다음 단계 계획

1. **리포트 요약 모델 재학습 (200 examples)**  
   - `training_report_summary_sft_200.jsonl` 기반으로 LoRA 재학습  
   - 학습 손실·출력 문장 품질·JSON 형식 준수 여부를 재평가
2. **카테고리 및 도메인 확장**  
   - DB에서 유아동 관련 추가 카테고리를 포함해 SFT 데이터 다양성 확대  
   - 향후 베트남 시장 외 타 국가/도메인에도 확장 가능하도록 템플릿 일반화 검토
3. **브랜드/채널 레벨 세부 Insight 확장**  
   - “레고/벨베이비/옥스포드…” 예시처럼, 특정 브랜드·채널 단위 리뷰 톤 분석을 통해  
     카테고리 리포트 하단에 **브랜드별 요약 블록**을 추가하는 모듈 설계
4. **백엔드 연동 및 운영 시나리오 정의**  
   - Node.js 백엔드에서 `25_generate_category_report_from_csv.py` 또는 DB직접 버전과 연동  
   - 운영 환경에서는 **템플릿 기반 요약 + 모델 출력(선택)** 구조로 안정성과 유연성을 동시에 확보

